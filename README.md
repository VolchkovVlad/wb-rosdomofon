## Описание
WB-ROSDOMOFON - это проект для интеграции сервиса РосДомофон с контроллерами Wiren Board.

Сервис позволяет:
- Открывать двери / ворота / калитки / шлагбаумы
- Получать RTSP ссылки для просмотра камер
- Редактировать настройки пользователя:
  - Заглушить звонки
  - Заглушить уведомления от чатов
 
Планируется к добавлению: 
- Определение вызова
- Функция автофахтера / курьера. (Автоматическое открытие двери при звонке в квартиру)
---
Взаимодействие с РосДомофон: [РосДомофон API](https://rdba.rosdomofon.com/swagger-ui.html?urls.primaryName=abonents) <br>
MQTT топики формируются согласно [Wiren Board MQTT Conventions](https://github.com/wirenboard/conventions/tree/main)


## Навигация
- [Установка](#установка)
- [Удаление](#удаление)
- [Авторизация](#авторизация)
  - [Параметры пользователя](#параметры-пользователя)
  - [Домофон с камерой](#домофон-с-камерой)
- [Конфигурационный файл](#конфигурационный-файл)
- [Интеграция в SprutHub](#интеграция-с-spruthub)
  - [Замок](#добавление-замка)
  - [Камера](#добавление-камеры)
  - [Пример отображения](#отображение-в-spruthub)

## Установка
1) Подключаемся к контроллеру Wiren Board по SSH. <br>
`По умолчанию логин: root | пароль: wirenboard`
2) Копируем и вставляем команду:
```bash
curl -fsSL https://raw.githubusercontent.com/VolchkovVlad/wb-rosdomofon/main/install.sh | sh
```

## Удаление
1) Подключаемся к контроллеру Wiren Board по SSH. <br>
`По умолчанию логин: root | пароль: wirenboard`
2) Переходим в директорию 
```bash
cd /mnt/data/wb-rosdomofon
```
3) Вызываем файл удаления 
```bash
./uninstall.sh
```
## Авторизация
Для авторизации, необходимо открыть вкладку "Устройства" веб интерфейс контроллера Wiren Board.
<p align="left">
  <img src="docs/img/Auth.png" width="500">
</p>

1) Введите номер телефона привязанный к аккаунту (Можно вводить начиная с 8 скрипт подправит на +7)
2) Нажимаете `Отправить SMS` (Если запрос отработал корректно, кнопка изменится на `✅ SMS | Повтор через 60 сек.`)
3) Введите полученый код подтверждения
4) Нажимаете `Отправить код`

При успешной авторизации, контролы для входа удалятся автоматически, а на их месте появится информация о пользователе: 
   
### Параметры пользователя
<p align="left">
  <img src="docs/img/UserInfo.png" width="500">
</p>

- `Количество устройств` - Количество адаптеров доступных для управления пользователем. <br>
- `Прочитать настройки пользователя` - Выполняет запрос на сервер и публикацию настроек пользователя. <br>
- `Настройки: Заглушить звонки` - Позволяет выключить входящие звонки. <br>
- `Настройки: Заглушить чаты` - Позволяет выключить уведомления от чатов. <br>
- `Токен обновлен ` - Дата и время когда было произведено последнее обновление **access_token**. <br>
- `Токен доступа` - **access_token** необходимый для выполнения практически всех запросов. <br>

> Ввиду того что **access_token** является временным, и его время жизни не более 4999 секунд. <br>
Мы его публикуем в MQTT не переживая за безопасность, для ускорения проверки запросов к API. <br>
А так же публикуем дату и время последнего обновления токена. <br>
Т.к. данные параметры в основном нужны для ускорения разработки, в будущих версиях планируется их удаление.

### Домофон с камерой
<p align="left">
  <img src="docs/img/Intercom.png" width="500">
</p>

- `Статус замка`<br>
  - 0: Открыт - Публикуется если API вернул нам: `"activityResult": "opendoor_complete"` на команду открытия двери.
  - 1: Закрыт - Публикуется при загрузке драйвера и через 5 секунд после открытия двери.
  - 2: Зажат  - Публикуется если запрос к API не удался. (Нет ответа от сервера, или в ответе сообщается что запрос не корректный)
  - 3: Не известен
- `Замок`<br>
  - 0: Открыть
  - 1: Закрыть
- `Камера`
  - Ссылка на RTSP поток с камеры: Логин и пароль уже встроены в ссылку

> Формат ссылки на RTSP поток: rtsp://\<login\>:\<password\>@\<rtsp_url\><br>
Пример ссылки на RTSP поток: rtsp://test:Random2341@91.108.33.22:11066/H264?ch=1&subtype=0

## Конфигурационный файл
Конфигурационный файл хранит в себе информацию о всех добавленных пользователях РосДомофон. <br>
С его помощью можно:
- Удалять текущих пользователей
- Добавлять новых пользователей
- "Отключать" устройства (Позволяет скрывать устройства).
- Менять настройки подключения к MQTT Брокеру. (IP, Порт, Логин, Пароль)

![Открытие конфигурационного файла](docs/img/OpenConfig.png)
Для открытия конфигурационного файла необходимо в веб интерфейсе контроллера Wiren Board:
1) Открыть настройки
2) Вкладка конфигурационные файлы
3) Драйвер РосДомофон

![Пример отображения конфигурационного файла](docs/img/ConfigFile.png)

## Интеграция с SprutHub
---
### Добавление замка

1. Скачиваем шаблон для замка:  [Шаблон для версии SprutHub 1.12.8](examples/SprutHub_lock.json)  
   Для более новых версий SprutHub вероятно потребуется обновить шаблон:  [Сервис для создания / обновления шаблонов](https://kirillashikhmin.github.io/sht/editor/)

2. Открываем веб-интерфейс SprutHub одним из способов:
   - [web.spruthub.ru](https://web.spruthub.ru)
   - `<IP контроллера с SH>:7777`

<p align="center">
  <img src="docs/img/openCatalog.png">
</p>

3. Открываем вкладку «Каталог»
4. В правом верхнем углу нажимаем «+»

<p align="left">
  <img src="docs/img/ControllerMQTT.png" width="700">
</p>

5. В списке выбираем «MQTT»
6. Загружаем шаблон файлом либо вставляем содержимое вручную

<p align="left">
  <img src="docs/img/Search.png" width="700">
</p>

7. Открываем вкладку «Контроллеры»
8. Запускаем поиск устройств в MQTT-контроллере

---
### Добавление камеры
1) Открываем веб-интерфейс SprutHub одним из способов:
   - [web.spruthub.ru](https://web.spruthub.ru)
   - `<IP контроллера с SH>:7777`
2) Открываем вкладку "Контроллеры"
3) В правом верхнем углу нажимаем "+"
4) Нажимаем "+ Добавить расширение"
5) В списке выбираем "Камеры" (RTSP/ONVIF)
6) Открываем настройки контроллера "Камеры"
7) Вводим: RTSP ссылку, логин и пароль 
---
### Отображение в SprutHub

## Похожие проекты
- rosdomofon-ha: https://github.com/iljyxa/rosdomofon-ha тот же функционал, но для использования с Home Assistant
